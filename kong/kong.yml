_format_version: "3.0"
_transform: true

services:
  - name: onlix-user
    # url: http://user-service:8000 # prod
    url: http://172.17.224.1:8081 # dev
    routes:
      # 로그인, RT 발급 등 API : JWT 검증 없이 통과 (Public)
      - name: user-auth-public
        paths: 
          - "/api/user/auth/login"
          - "/api/user/auth/signin"
          - "/api/user/auth/refresh"
        strip_path: false

      # 나머지 유저 API: JWT 검증 (Protected)
      - name: user-auth-protected
        paths: 
          - "/api/user/auth/me"
          - "/api/user/auth/logout"
          - "/api/user/auth/admin"
        strip_path: false
        plugins:
          - name: jwt
            config:
              run_on_preflight: false
              key_claim_name: "iss"
              claims_to_verify: ["exp"]
              header_names: ["authorization"]
              cookie_names: ["accessToken"]
          - name: kong-jwt2header
            config:
              strip_claims: "false"
              token_required: "true"
  - name: onlix-catalog
    #url: http://catalog-service:8000 # prod
    url: http://172.17.224.1:8082 # dev
    routes:
      # 상품 리스트 조회 등 API : JWT 검증 없이 통과 (Public)
      - name: catalog-public
        paths:
          - "/api/catalog"
        strip_path: false
     
      # - name: catalog-protected
      #   paths: ["/api/catalog"]
      #   strip_path: false
      #   plugins:
      #     - name: jwt
      #       config:
      #         run_on_preflight: false
      #         key_claim_name: "iss"
      #         claims_to_verify: ["exp"]
      #         header_names: ["authorization"]
      #         cookie_names: ["accessToken"]
      #     - name: kong-jwt2header
      #       config:
      #         strip_claims: "false"
      #         token_required: "true"

# dev에서는 프론트 로컬 오리진 허용
plugins:
  - name: cors
    config:
      origins:
        - "http://localhost:3000"
        - "http://127.0.0.1:3000"
      methods: ["GET","POST","PUT","DELETE","OPTIONS"]
      headers: ["Authorization","Content-Type"]
      credentials: true
      max_age: 3600
consumers:
  - username: "onlix-issuer"
    jwt_secrets:
      - key: "onlix-auth"
        algorithm: "HS256"
        secret: "onlix-auth-secret-key-for-dev-change-me"
